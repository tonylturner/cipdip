# Packet Capture Analysis Guide

This guide explains how to use the `cipdip pcap`, `cipdip pcap-summary`, `cipdip pcap-report`, `cipdip pcap-coverage`, `cipdip pcap-classify`, and `cipdip pcap-dump` commands to analyze EtherNet/IP packet captures.

## Overview

The `cipdip pcap` command analyzes raw EtherNet/IP packet data and provides:
- Packet structure analysis
- ODVA compliance validation
- Packet comparison
- Hex dump output
The `cipdip pcap-summary` command summarizes ENIP/CIP traffic across full PCAP files.
The `cipdip pcap-report` command generates a Markdown report for many PCAPs at once.
The `cipdip pcap-coverage` command summarizes CIP request coverage (service + class/instance/attribute).
The `cipdip pcap-classify` command uses `tshark` to classify PCAPs for integrity/noise signals.
The `cipdip pcap-dump` command extracts sample CIP packets for a specific service code.

## Basic Usage

### Analyze a Packet

```bash
cipdip pcap --input packet.bin
```

### Display Hex Dump

```bash
cipdip pcap --input packet.bin --hexdump
```

This will display:
- ENIP command code
- Session ID
- Data length
- Status
- Validity check
- Hex dump of the packet

### Validate ODVA Compliance

```bash
cipdip pcap --input packet.bin --validate
```

This performs additional checks:
- ENIP header structure (24 bytes)
- Length field consistency
- Status field validation
- Sender context validation
- Options field validation

### Compare Two Packets

```bash
cipdip pcap --input packet1.bin --compare packet2.bin
```

This compares:
- ENIP command codes
- Session IDs
- Data lengths
- Status values
- CIP data content

### Display Hex Dump

```bash
cipdip pcap --input packet.bin --hexdump
```

Displays a formatted hex dump of the raw packet data with ASCII representation.

### JSON Output

```bash
cipdip pcap --input packet.bin --format json
```

Outputs structured JSON for programmatic processing.

## Packet File Format

The `--input` file should contain raw binary EtherNet/IP packet data:
- ENIP header (24 bytes)
- ENIP data (variable length)

### Creating Packet Files

#### From Wireshark

1. Capture packets in Wireshark
2. Filter for EtherNet/IP (port 44818 or 2222)
3. Right-click packet -> "Export Packet Bytes"
4. Save as binary file

#### From tcpdump

```bash
# Capture to file
tcpdump -i <iface> -w capture.pcap port 44818

# Extract specific packet (requires additional tools)
# Or use Wireshark to export packet bytes
```

#### From cipdip itself

You can capture packets generated by `cipdip` using:
- `tcpdump` or `wireshark` while running scenarios
- Network monitoring tools
- Packet capture libraries

## Example Output

### Text Format

```
ENIP Packet Analysis:
  Command: 0x0065
  Session ID: 0x12345678
  Data Length: 4 bytes
  Status: 0x00000000
  Valid: true

Packet Hex Dump:
ENIP Header (24 bytes):
0000: 00 65 00 04 12 34 56 78 00 00 00 00 01 02 03 04  | .e...4Vx........
0010: 05 06 07 08 00 00 00 00                          | ........

ENIP Data:
0018: 00 01 00 00                                       | ....
```

### JSON Format

```json
{
  "command": "0x0065",
  "session_id": "0x12345678",
  "data_length": 4,
  "status": "0x00000000",
  "is_valid": true
}
```

## Use Cases

### 1. Protocol Compliance Testing

Validate that generated packets are ODVA-compliant:

```bash
# Generate traffic and capture
tcpdump -i <iface> -w capture.pcap port 44818 &
cipdip client --ip 10.0.0.50 --scenario baseline

# Extract and validate a packet
cipdip pcap --input packet.bin --validate
```

### 2. Vendor Comparison

Compare packets from different vendors:

```bash
# Capture from Rockwell device
cipdip pcap --input rockwell_packet.bin > rockwell_analysis.txt

# Capture from Schneider device
cipdip pcap --input schneider_packet.bin > schneider_analysis.txt

# Compare
cipdip pcap --input rockwell_packet.bin --compare schneider_packet.bin
```

### 3. Debugging

Analyze problematic packets:

```bash
# Analyze a packet that caused issues
cipdip pcap --input error_packet.bin --validate

# Check for compliance issues
# Review hex dump for structure problems
```

### 4. Documentation

Generate packet examples for documentation:

```bash
# Analyze and document packet structure
cipdip pcap --input example_packet.bin > packet_documentation.txt
```

## Vendor Research

When researching vendor-specific implementations, capture from real devices, analyze with `cipdip pcap`, and compare against ODVA requirements.

## Limitations

- `cipdip pcap` supports raw binary packet files only (use Wireshark to export)
- `cipdip pcap` does not parse PCAP format directly
- Does not handle fragmented packets
- Focuses on ENIP layer, not full Ethernet/IP/TCP headers

## Future Enhancements

Potential improvements:
- Direct PCAP file support
- Batch processing of multiple packets
- Statistical analysis of packet captures
- Integration with Wireshark dissector
- Support for reading from network interfaces

## PCAP Summary

Summarize a full capture:

```bash
cipdip pcap-summary --input pcaps/stress/ENIP.pcap
```

Note: EPATH 16-bit counters track the segment type used on the wire (0x21/0x25/0x31),
not the numeric width of the class/instance/attribute shown in Top Paths.

## PCAP Report

Generate a multi-file report (no `tshark` required):

```bash
cipdip pcap-report --pcap-dir pcaps --output notes/pcap_summary_report.md
```

## PCAP Coverage

Summarize CIP request coverage across all PCAPs:

```bash
cipdip pcap-coverage --pcap-dir pcaps --output notes/pcap_coverage.md
```

## PCAP Classification

Classify PCAPs using `tshark` filters:

```bash
cipdip pcap-classify --pcap-dir pcaps
```

If `tshark` is not on PATH, provide an explicit path:

```bash
cipdip pcap-classify --pcap-dir pcaps --tshark "C:\Program Files\Wireshark\tshark.exe"
```

## PCAP Dump

Extract sample CIP packets for a specific service code:

```bash
cipdip pcap-dump --input pcaps/stress/ENIP.pcap --service 0x51 --max 5 --payload
```

## See Also

- `docs/COMPLIANCE.md` - Protocol compliance documentation

