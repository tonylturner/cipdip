# Reference Packet Library

The reference packet library contains known-good ODVA-compliant CIP/ENIP packets extracted from PCAP files. These packets are used for validation and comparison to ensure CIPDIP generates compliant traffic.

## Overview

Reference packets are extracted from:
- **CIPDIP Baseline Captures** (`baseline_captures/*.pcap`) - Packets generated by CIPDIP itself
- **Real-World Captures** (`.cursorrules/pcaps/*.pcap`) - Packets from actual CIP/EtherNet-IP devices

## Current Status

✅ **Populated Packets:**
- `RegisterSession_Response` (28 bytes) - From CIPDIP baseline captures
- `GetAttributeSingle_Request` (37 bytes) - From CIPDIP baseline captures
- `SetAttributeSingle_Request` (41 bytes) - From CIPDIP baseline captures
- `ForwardOpen_Request` (62 bytes) - From CIPDIP baseline captures
- `ForwardClose_Request` (42 bytes) - From CIPDIP baseline captures
- `SendUnitData_Request` (36 bytes) - From CIPDIP baseline captures

⏳ **Missing Packets:**
- `RegisterSession_Request` - Need to extract from PCAP
- `GetAttributeSingle_Response` - Need to extract from PCAP
- `ForwardOpen_Response` - Need to extract from PCAP

## Usage

### Extracting Reference Packets

To extract reference packets from PCAP files:

```bash
# Extract from default locations (baseline_captures/ and .cursorrules/pcaps/)
cipdip extract-reference

# Extract and generate Go source file
cipdip extract-reference --output internal/cipclient/reference_packets_gen.go

# Extract from custom directories
cipdip extract-reference --baseline-dir ./my_captures --real-world-dir ./real_pcaps
```

### Comparing Generated Packets

```go
import "github.com/tturner/cipdip/internal/cipclient"

// Generate a packet
packet := cipclient.BuildRegisterSession(senderContext)

// Compare with reference
match, err := cipclient.CompareWithReference("RegisterSession_Request", packet)
if err != nil {
    return err
}
if !match {
    // Find differences
    offset, genByte, refByte := cipclient.FindFirstDifference(packet, ref.Data)
    fmt.Printf("Difference at offset %d: generated 0x%02X, reference 0x%02X\n", 
        offset, genByte, refByte)
}
```

### Validating Packet Structure

```go
// Validate packet structure matches expected
err := cipclient.ValidatePacketStructure(packet, "RegisterSession_Response")
if err != nil {
    return fmt.Errorf("packet structure invalid: %w", err)
}
```

## Packet Normalization

Reference packets are normalized before storage:
- **Session IDs are zeroed** - Allows comparison across different sessions
- **Sender context is preserved** - Part of the protocol structure

This normalization allows reference packets to be used for structural validation even when session IDs differ.

## Adding New Reference Packets

1. **Capture packets** using Wireshark or tcpdump
2. **Save PCAP files** to `baseline_captures/` or `.cursorrules/pcaps/`
3. **Run extraction**:
   ```bash
   cipdip extract-reference --output internal/cipclient/reference_packets_gen.go
   ```
4. **Verify** the generated file contains the new packets
5. **Test** using `go test ./internal/cipclient/... -run TestReferencePackets`

## Testing

Reference packets are validated in `internal/cipclient/reference_test.go`:

```bash
# Run reference packet tests
go test ./internal/cipclient/... -run TestReferencePackets -v

# Test comparison functions
go test ./internal/cipclient/... -run TestCompareWithReference -v
```

## File Structure

- `internal/cipclient/reference.go` - Reference packet definitions and comparison functions
- `internal/cipclient/reference_packets_gen.go` - Generated file with actual packet data (auto-generated)
- `internal/cipclient/pcap_extract.go` - PCAP extraction utilities
- `cmd/cipdip/extract_reference.go` - CLI command for extraction

## Future Work

1. **Extract missing packets** from PCAP files
2. **Add real-world device packets** from `.cursorrules/pcaps/`
3. **Add response packets** (currently mostly requests)
4. **Add vendor-specific packets** for vendor research
5. **Automated validation** against reference packets in CI

## See Also

- `internal/cipclient/validation.go` - Packet validation layer
