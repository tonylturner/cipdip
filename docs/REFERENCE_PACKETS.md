# Reference Packet Library

The reference packet library contains CIP/ENIP packets extracted from PCAP files. These packets are used for structural validation, regression checks, and comparisons to ensure CIPDIP generates consistent traffic.

## Overview

Reference packets are extracted from:
- **CIPDIP Baseline Captures** (`baseline_captures/*.pcap`) - Packets generated by CIPDIP for regression/consistency checks
- **Real-World Captures** (`pcaps/normal/*.pcap`, `pcaps/stress/*.pcap`) - Packets from actual CIP/EtherNet-IP devices
- **Not CIP** (`pcaps/not_cip/*.pcap`) - Included in scans but expected to yield no reference packets

Baseline captures are not a source of truth for ODVA compliance. They are useful for detecting regressions and ensuring deterministic output, but compliance validation should rely on ODVA specs, real-world captures, and external tooling.
See `docs/COMPLIANCE_TESTING.md` for reference coverage limitations.

## Current Status

**Real-world packets (current):**
- `RegisterSession_Request` (28 bytes)
- `ListIdentity_Request` (24 bytes)
- `GetAttributeSingle_Request` (48 bytes)
- `GetAttributeSingle_Response` (44 bytes)
- `SetAttributeSingle_Request` (52 bytes)
- `SetAttributeSingle_Response` (44 bytes)
- `ForwardOpen_Request` (86 bytes)
- `ForwardOpen_Response` (70 bytes)
- `ForwardClose_Request` (62 bytes)
- `ForwardClose_Response` (54 bytes)
- `SendUnitData_Request` (82 bytes)

**Still missing (little-endian) reference:**
- `RegisterSession_Response`

Last extraction run:
`cipdip extract-reference --real-world-dir pcaps --output internal/cipclient/reference_packets_gen.go`

Last extraction run (UTC): `2026-01-02T22:36:14.3456981Z`
Results:
- PCAPs scanned: 39
- Baseline captures: 0 packets (regression only)
- Real-world captures: 64 packets
- Still missing: `RegisterSession_Response`

## Usage

### Extracting Reference Packets

To extract reference packets from PCAP files:

```bash
# Extract from default locations (baseline_captures/ and pcaps/)
cipdip extract-reference

# Extract and generate Go source file
cipdip extract-reference --output internal/cipclient/reference_packets_gen.go

# Extract from custom directories
cipdip extract-reference --baseline-dir ./my_captures --real-world-dir ./real_pcaps
```

### Comparing Generated Packets

```go
import "github.com/tturner/cipdip/internal/cipclient"

// Generate a packet
packet := cipclient.BuildRegisterSession(senderContext)

// Compare with reference
match, err := cipclient.CompareWithReference("RegisterSession_Request", packet)
if err != nil {
    return err
}
if !match {
    // Find differences
    offset, genByte, refByte := cipclient.FindFirstDifference(packet, ref.Data)
    fmt.Printf("Difference at offset %d: generated 0x%02X, reference 0x%02X\n", 
        offset, genByte, refByte)
}
```

### Validating Packet Structure

```go
// Validate packet structure matches expected
err := cipclient.ValidatePacketStructure(packet, "RegisterSession_Response")
if err != nil {
    return fmt.Errorf("packet structure invalid: %w", err)
}
```

## Packet Normalization

Reference packets are normalized before storage:
- **Session IDs are zeroed** - Allows comparison across different sessions
- **Sender context is preserved** - Part of the protocol structure

This normalization allows reference packets to be used for structural validation even when session IDs differ.

## Adding New Reference Packets

1. **Capture packets** using Wireshark or tcpdump
2. **Save PCAP files** to `baseline_captures/` (regression), `pcaps/normal/`, or `pcaps/stress/` (real-world)
3. **Run extraction**:
   ```bash
   cipdip extract-reference --output internal/cipclient/reference_packets_gen.go
   ```
4. **Verify** the generated file contains the new packets
5. **Test** using `go test ./internal/cipclient/... -run TestReferencePackets`

## Testing

Reference packets are validated in `internal/cipclient/reference_test.go`:

```bash
# Run reference packet tests
go test ./internal/cipclient/... -run TestReferencePackets -v

# Test comparison functions
go test ./internal/cipclient/... -run TestCompareWithReference -v
```

## File Structure

- `internal/cipclient/reference.go` - Reference packet definitions and comparison functions
- `internal/cipclient/reference_packets_gen.go` - Generated file with actual packet data (auto-generated)
- `internal/cipclient/pcap_extract.go` - PCAP extraction utilities
- `cmd/cipdip/extract_reference.go` - CLI command for extraction

## Future Work

1. **Extract missing packets** from real-world PCAP files
2. **Add response packets** (currently mostly requests)
3. **Add vendor-specific packets** from real devices
4. **Automated validation** against reference packets in CI (real-world preferred)

## See Also

- `internal/cipclient/validation.go` - Packet validation layer
